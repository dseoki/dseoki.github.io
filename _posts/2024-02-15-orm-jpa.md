---
title: Spring JPA(ORM)ì˜ N+1 ë¬¸ì œ
summary: ORM/JPAì˜ n+1ë¬¸ì œì™€ í•´ê²°ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ì
categories: [ORM, JPA]
comments: true
---

## N + 1?
ORMì˜ JPAë¥¼ ì‚¬ìš©í•˜ë‹¤ ë³´ë©´ n+1 ë¬¸ì œê°€ ë°œìƒí•˜ê²Œ ëœë‹¤. ë‚´ê°€ ì˜ë„ì¹˜ ì•Šì€ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ëŠ”ë° ë”ë¶ˆì–´ ì—¬ëŸ¬ë²ˆ ë°˜ë³µëœë‹¤ë©´ ë¬¸ì œê°€ ë§ì•„ì§„ë‹¤. ì´ëŸ¬í•œ ë¬¸ì œì— ëŒ€í•´ì„œ ì •ë¦¬í•´ë³´ì.

í”íˆ n+1 ë¬¸ì œë¼ê³  í•˜ëŠ”ê²ƒì€ ì—°ê´€ê´€ê³„ë¡œ ë§¤í•‘ëœ ì—”í‹°í‹°ë¥¼ ì¡°íšŒ ì‹œ ì˜ë„ì¹˜ ì•Šê²Œ ê°™ì€ ì¿¼ë¦¬ê°€ ì—¬ëŸ¬ë²ˆ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ ë§í•œë‹¤.

#### Member Entity
```java
@Entity
@Getter
@Setter
public class Member {
    @Id
    @GeneratedValue
    @Column(name = "MEMBER_ID")
    private Long id;

    private String userName;

    private int age;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "TEAM_ID")
    private Team team;

    // ìƒëµ...
}
```

#### Team Entity
```java
@Entity
@Getter
@Setter
public class Team {

    @Id
    @GeneratedValue
    @Column(name = "TEAM_ID")
    private Long teamId;

    private String name;

    @OneToMany(mappedBy = "team")
    private List<Member> members = new ArrayList();

    // ìƒëµ...
}
```

ìœ„ì™€ ê°™ì€ ì—”í‹°í‹°ê°€ ìˆë‹¤ê³  ê°€ì •í•  ë•Œ Teamì€ ì—¬ëŸ¬ê°œì˜ Memberë¥¼ ê°€ì§ˆ ìˆ˜ ìˆë‹¤. ì´ë•Œ List íƒ€ì…ì˜ Teamì„ ë°˜ë³µë¬¸ì„ í†µí•´ members ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¡°íšŒ ì‹œ ë¬¸ì œê°€ ë°œìƒí•œë‹¤.

```java
List<Team> teams = teamRepository.findAll();

for (Team team : teams) {
    System.out.println("members = " + team.members());
}
```

JPAì—ëŠ” Fetch Typeì´ ìˆëŠ”ë° ì¿¼ë¦¬ ì¡°íšŒ ì‹œ ì¦‰ì‹œ ë§¤í•‘í•˜ì—¬ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” Eager, ì¿¼ë¦¬ ì¡°íšŒ í›„ ì˜ì†ì„± ë‹¨ê³„ì—ì„œ í•˜ìœ„ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•  ë•Œ í˜¸ì¶œí•˜ëŠ” Lazyê°€ ìˆë‹¤. ê²°êµ­ ì´ ë‘˜ë‹¤ N+1ì´ ë°œìƒí•˜ê²Œ ë˜ëŠ”ë° í•˜ë‚˜ì˜ ì—”í‹°í‹°ì— í•˜ìœ„ ì—”í‹°í‹°ë¥¼ í˜¸ì¶œ ì‹œ ìƒìœ„ ì—”í‹°í‹°ì˜ ë¦¬ìŠ¤íŠ¸ ë§Œí¼ JPQLì´ ë‹¤ì‹œ í˜¸ì¶œí•˜ê¸° ë–„ë¬¸ì— ê°™ì€ ì¿¼ë¦¬ê°€ Në²ˆ ë‚˜íƒ€ë‚œê²Œ ëœë‹¤.

ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ ì—¬ëŸ¬ê°€ì§€ì˜ ë°©ë²•ì´ ìˆë‹¤.

### ğŸ“– Fetch Join(íŒ¨ì¹˜ ì¡°ì¸)
ë¯¸ë¦¬ ì¿¼ë¦¬ë¡œ ì¡°ì¸í•˜ì—¬ ê°ì²´ íƒ€ì…ìœ¼ë¡œ ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ë‹¤.

```java
@Query("SELECT t FROM TEAM t JOIN FETCH t.members")
List<Team> findTeamJoinFetch();
```
```java
List<Team> teams = findTeamJoinFetch();

for (Team team : teams) {
    System.out.println("members = " + team.members());
}
```

ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ë©´ ì¿¼ë¦¬ëŠ” 1ë²ˆë§Œ ë°œìƒí•˜ê³  ë‘ í…Œì´ë¸”ì„ ì¡°ì¸í•˜ì—¬ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
íŒ¨ì¹˜ì¡°ì¸ì—ëŠ” ë‹¨ì ì´ 2ê°€ì§€ ìˆë‹¤.
1. `JPA`ê°€ ì œê³µí•˜ëŠ” `Pageable`ê¸°ëŠ¥ ì‚¬ìš© ë¶ˆê°€
2. `1:N`ê´€ê³„ê°€ 2ê°œì¸ ì—”í‹°í‹°ë¥¼ íŒ¨ì¹˜ ì¡°ì¸ ì‚¬ìš© ë¶ˆê°€

### ğŸ“– Betch Size ì¡°ì ˆ
ì„¤ì •í•œ `size`ë§Œí¼ ë°ì´í„°ë¥¼ ë¯¸ë¦¬ ë¡œë”©í•œë‹¤. (JPQLì´ where in ì‚¬ìš©í•œë‹¤.)


### ğŸ“– @EntityGraph
ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ í•„ë“œëª…ì„ ì§€ì •í•˜ë©´ í•´ë‹¹ í•„ë“œê°€ ì§€ì—° ë¡œë”©ì´ ì•„ë‹Œ ì¦‰ì‹œ ë¡œë”©ìœ¼ë¡œ ì¡°íšŒ ë˜ëŠ”ê²ƒ ì´ë¼ê³  ë³´ì‹œë©´ ëœë‹¤.
